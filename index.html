<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚è∞</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Login/Landing Page -->
    <div id="login-page" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <div class="login-icon">‚è∞</div>
                <h1>Focus Tracker</h1>
                <p>Track your tasks and focus time</p>
            </div>

            <div class="google-signin-container">
                <button onclick="handleGoogleSignIn()" class="btn-google-signin" id="google-signin-btn">
                    <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                        <path fill="#4285F4"
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                        <path fill="#34A853"
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                        <path fill="#FBBC05"
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                        <path fill="#EA4335"
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                    </svg>
                    <span>Sign in with Google</span>
                </button>
                <div id="auth-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="app-container" class="container" style="display: none;">
        <header>
            <div class="header-content">
                <h1>Todo List</h1>
                <div class="user-info">
                    <span id="user-email"></span>
                    <button onclick="handleSignOut()" class="btn-signout">Sign Out</button>
                </div>
            </div>
        </header>

        <!-- Dashboard -->
        <div class="dashboard collapsible-section">
            <div class="section-header" onclick="app.toggleSection('dashboard')">
                <h2>Dashboard</h2>
                <span class="collapse-icon" id="dashboard-icon">‚ñº</span>
            </div>
            <div class="section-content" id="dashboard-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-info">
                            <div class="stat-label">Total Focus Time</div>
                            <div class="stat-value" id="totalFocusTime">00:00:00</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <div class="stat-label">Completed Tasks</div>
                            <div class="stat-value" id="completedTasks">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-info">
                            <div class="stat-label">Outstanding Tasks</div>
                            <div class="stat-value" id="outstandingTasks">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üò¥</div>
                        <div class="stat-info">
                            <div class="stat-label">Idling Time</div>
                            <div class="stat-value" id="idlingTime">00:00:00</div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-actions">
                    <div class="reset-times-wrapper">
                        <button type="button" class="btn-reset-times" onclick="app.resetTimes()">Reset Focus & Idling
                            Time</button>
                        <button type="button" class="btn-test-firebase" style="display:none;"
                            onclick="testFirebaseConnection(event)">Test Firebase Connection</button>
                        <span class="last-reset-time" id="lastResetTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List (with Add New Task underneath the Tasks tab) -->
        <div class="tasks-section collapsible-section">
            <div class="section-header" onclick="app.toggleSection('tasks')">
                <h2>Tasks</h2>
                <span class="collapse-icon" id="tasks-icon">‚ñº</span>
            </div>
            <div class="section-content" id="tasks-content">
                <div class="tasks-columns">
                    <div class="tasks-column tasks-column-left">
                        <div id="taskList" class="task-list">
                            <!-- Tasks will be dynamically added here -->
                        </div>
                        <div class="add-task-collapsible collapsible-section">
                            <div class="section-header add-task-header" onclick="app.toggleAddTaskSection()">
                                <h3 class="add-task-heading">Add New Task</h3>
                                <span class="collapse-icon" id="add-task-icon">‚ñº</span>
                            </div>
                            <div class="section-content" id="add-task-content">
                                <form id="taskForm">
                                    <div class="form-group">
                                        <label for="taskInput">Task Description</label>
                                        <input type="text" id="taskInput" placeholder="Enter task description..."
                                            required>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="deadlineDate">Deadline Date</label>
                                            <input type="date" id="deadlineDate" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="deadlineTimeHour">Deadline Time</label>
                                            <div class="time-selects">
                                                <select id="deadlineTimeHour" required></select>
                                                <span class="time-sep">:</span>
                                                <select id="deadlineTimeMin" required></select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex-row">
                                        <button type="submit" class="btn btn-primary">Add Task</button>

                                        <button type="button" class="btn btn-coding" id="add-coding-task-btn"
                                            style="margin-top:10px;">Add
                                            Coding
                                            Task</button>
                                    </div>

                                </form>
                            </div>
                        </div>

                        <!-- Add Coding Task Modal -->
                        <div id="coding-task-modal" class="modal-overlay" style="display: none;" aria-hidden="true">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>Add Coding Task</h3>
                                    <button type="button" class="modal-close" id="coding-modal-close"
                                        aria-label="Close">&times;</button>
                                </div>
                                <form id="codingTaskForm">
                                    <div class="form-group">
                                        <label for="codingTaskTitle">Task Title</label>
                                        <input type="text" id="codingTaskTitle" placeholder="e.g. WWTP Design Portfolio"
                                            required>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="codingDeadlineDate">Deadline Date</label>
                                            <input type="date" id="codingDeadlineDate" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="codingDeadlineTimeHour">Deadline Time</label>
                                            <div class="time-selects">
                                                <select id="codingDeadlineTimeHour" required></select>
                                                <span class="time-sep">:</span>
                                                <select id="codingDeadlineTimeMin" required></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="codingTaskHyperlink">Hyperlink (Optional)</label>
                                        <input type="url" id="codingTaskHyperlink" placeholder="https://example.com">
                                        <span class="form-hint">Add a link to open in a new tab from the checklist.</span>
                                    </div>
                                    <div class="form-group">
                                        <label for="codingCsvPaste">Paste CSV (Task_ID, Week, Cursor_Prompt,
                                            Expected_Outcome, Rationale)</label>
                                        <textarea id="codingCsvPaste" rows="12"
                                            placeholder="Paste your CSV here. First row = headers, rows 2+ = sub-tasks."></textarea>
                                        <span class="form-hint">First row is headers. Each data row becomes a sub-task
                                            with a Finish button.</span>
                                    </div>
                                    <div class="modal-actions">
                                        <button type="button" class="btn btn-secondary"
                                            id="coding-modal-cancel">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Create Coding Task</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tasks-column tasks-column-right coding-checklist-column-hidden"
                        id="codingChecklistColumn">
                        <div class="coding-checklist-panel">
                            <div class="coding-checklist-panel-header">
                                <h3 class="coding-checklist-title">Checklist</h3>
                                <button type="button" class="btn-hide-checklist" id="hideChecklistBtn"
                                    title="Hide checklist">Hide checklist</button>
                            </div>
                            <div id="codingChecklistPlaceholder" class="coding-checklist-placeholder">Select a coding
                                task from the list to view its checklist.</div>
                            <div id="codingChecklistList" class="coding-checklist-list" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <div class="remark-section collapsible-section collapsed">
                    <div class="section-header" onclick="app.toggleSection('remark')">
                        <h3 class="remark-heading">Remark</h3>
                        <span class="collapse-icon" id="remark-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="remark-content">
                        <div id="remarkBox" class="remark-box">
                            <!-- Single remark will be displayed/edited here -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Load Firebase config from environment variables or config.js
        (function () {
            // Try to get config from Netlify environment variables first (available at build time)
            // Otherwise, it will be loaded from config.js
            if (typeof window.firebaseConfig === 'undefined') {
                // For Netlify: environment variables are injected at build time
                // For local: config.js will set window.firebaseConfig
                window.firebaseConfig = window.firebaseConfig || {
                    apiKey: "AIzaSyDGsCT7vbnZUW1ftP0aWlUUE0EBX5yAlG4",
                    authDomain: "simpletodo-d088e.firebaseapp.com",
                    projectId: "simpletodo-d088e",
                    storageBucket: "simpletodo-d088e.firebasestorage.app",
                    messagingSenderId: "1090404696953",
                    appId: "1:1090404696953:web:77944ee04e4e58e21f65a8",
                    measurementId: "G-JCTWN23GGQ"
                };
            }
        })();
    </script>
    <script src="config.js?v=2" onerror="console.warn('config.js not found, using default config')"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Wait for config to be loaded (with a small delay to ensure config.js has loaded)
        function initFirebase() {
            if (!window.firebaseConfig) {
                console.error('Firebase configuration not found! Please ensure config.js exists and contains your Firebase credentials.');
                document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h2>Configuration Error</h2><p>Firebase configuration not found. Please ensure config.js exists.</p></div>';
                return;
            }

            try {
                // Log which config is being used for debugging
                console.log('üîß Loading Firebase config:', {
                    projectId: window.firebaseConfig?.projectId,
                    authDomain: window.firebaseConfig?.authDomain,
                    apiKey: window.firebaseConfig?.apiKey?.substring(0, 20) + '...'
                });

                // Initialize Firebase with configuration
                window.firebaseApp = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                // Make auth functions available globally
                window.signOut = signOut;
                window.signInWithPopup = signInWithPopup;
                window.GoogleAuthProvider = GoogleAuthProvider;
                console.log('‚úÖ Firebase initialized successfully with project:', window.firebaseConfig?.projectId);

                // Monitor authentication state
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        // User is signed in
                        console.log('‚úÖ User signed in:', user.email);
                        showApp(user);
                    } else {
                        // User is signed out
                        console.log('üë§ User signed out');
                        showLogin();
                    }
                });
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h2>Firebase Error</h2><p>Failed to initialize Firebase: ' + error.message + '</p></div>';
            }
        }

        // Wait a bit for config.js to load if it exists
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(initFirebase, 100);
            });
        } else {
            setTimeout(initFirebase, 100);
        }
    </script>

    <!-- Authentication Script -->
    <script>
        // Google Sign-In handler
        async function handleGoogleSignIn() {
            const errorDiv = document.getElementById('auth-error');
            const btn = document.getElementById('google-signin-btn');

            errorDiv.textContent = '';
            btn.disabled = true;
            btn.innerHTML = '<span>Signing in...</span>';

            try {
                if (!window.auth || !window.signInWithPopup || !window.GoogleAuthProvider) {
                    throw new Error('Firebase auth not initialized. Please refresh the page.');
                }

                const provider = new window.GoogleAuthProvider();
                // Remove hd restriction - let Google handle account selection, then validate email

                const result = await window.signInWithPopup(window.auth, provider);
                const user = result.user;

                // Debug: Log user info
                console.log('üîç User signed in:', {
                    email: user.email,
                    emailVerified: user.emailVerified,
                    providerData: user.providerData
                });

                // Check if user has email and signed in via Google
                if (!user.email) {
                    await window.signOut(window.auth);
                    throw new Error('No email found. Please try again.');
                }

                // Check if signed in via Google provider
                const isGoogleProvider = user.providerData &&
                    user.providerData.some(provider => provider.providerId === 'google.com');

                console.log('üîç Provider validation:', {
                    email: user.email,
                    isGoogleProvider: isGoogleProvider,
                    providerData: user.providerData
                });

                // Allow any Google-authenticated account (Gmail, Google Workspace, etc.)
                if (!isGoogleProvider) {
                    // Sign out the user if not signed in via Google
                    try {
                        await window.signOut(window.auth);
                    } catch (e) {
                        console.warn('Error signing out non-Google user:', e);
                    }
                    throw new Error('Only Google accounts are allowed. Please sign in with Google.');
                }

                console.log('‚úÖ Google account verified:', user.email);

                // onAuthStateChanged will handle showing the app
            } catch (error) {
                console.error('Google sign-in error:', error);
                let errorMessage = 'An error occurred during sign-in.';

                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in cancelled. Please try again.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Popup blocked. Please allow popups and try again.';
                } else if (error.message.includes('Gmail')) {
                    errorMessage = 'Only Gmail accounts are allowed.';
                } else if (error.code) {
                    errorMessage = getErrorMessage(error.code);
                } else if (error.message) {
                    errorMessage = error.message;
                }

                errorDiv.textContent = errorMessage;
                btn.disabled = false;
                btn.innerHTML = `
                    <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Sign in with Google</span>
                `;
            }
        }

        // Sign Out handler
        async function handleSignOut() {
            try {
                if (!window.auth || !window.signOut) {
                    throw new Error('Firebase auth not initialized');
                }
                await window.signOut(window.auth);
                // onAuthStateChanged will handle showing login page
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Error signing out: ' + error.message);
            }
        }

        // Show app, hide login
        function showApp(user) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('user-email').textContent = user.email;

            // The app will initialize automatically via onAuthStateChanged in script.js
            // Just ensure the app instance exists
            if (!window.app) {
                console.warn('App instance not found - creating new instance');
                window.app = new TodoApp();
            }
        }

        // Show login, hide app
        function showLogin() {
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            // Clear error
            document.getElementById('auth-error').textContent = '';
            // Reset button
            const btn = document.getElementById('google-signin-btn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Sign in with Google</span>
                `;
            }
        }

        // Get user-friendly error messages
        function getErrorMessage(errorCode) {
            const errors = {
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'An account with this email already exists',
                'auth/weak-password': 'Password is too weak',
                'auth/invalid-email': 'Invalid email address',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later',
                'auth/network-request-failed': 'Network error. Please check your connection'
            };
            return errors[errorCode] || 'An error occurred. Please try again';
        }
    </script>

    <script src="script.js?v=2"></script>
</body>

</html>